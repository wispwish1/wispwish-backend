<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wispwish Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo h2 {
            color: #667eea;
            font-size: 24px;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #555;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            margin-right: 12px;
            width: 20px;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome {
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .content-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    width: 100%;
}
.pagination-container{
     display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    width: 100%;
}

.pagination div {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
}

.pagination div:first-child {
    justify-content: flex-start;
}

.pagination div:last-child {
    justify-content: flex-end;
}

.pagination .page-info {
    margin: 0 20px;
} */

        .section-title {
            color: #333;
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 600;
        }

             .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
            /* Add responsive styling */
            table-layout: fixed;
            word-wrap: break-word;
        }

        
        /* Add responsive wrapper */
        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
        }
        /* Column width controls */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 15%; } /* Order ID */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 20%; } /* User */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 12%; } /* Gift Type */
        .data-table th:nth-child(4), .data-table td:nth-child(4) { width: 10%; } /* Price */
        .data-table th:nth-child(5), .data-table td:nth-child(5) { width: 12%; } /* Status */
        .data-table th:nth-child(6), .data-table td:nth-child(6) { width: 12%; } /* Date */
        .data-table th:nth-child(7), .data-table td:nth-child(7) { width: 19%; } /* Actions */
        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
             padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

            /* Order ID styling */
        .order-id {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .status-badge {
            padding: 5px 12px;
            color: #fff;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-refunded {
            background: #d1ecf1;
            color: #0c5460;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        /* Loading Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading-placeholder {
            animation: pulse 1.5s ease-in-out infinite;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            display: inline-block;
            min-width: 60px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Analytics Specific Styles */
        .analytics-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .chart-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .analytics-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
        }

        .metric-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-3px);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .metric-card:hover::before {
            left: 100%;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .analytics-charts {
                grid-template-columns: 1fr;
            }
            
            .analytics-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 250px;
            }
            
            .main-content {
                margin-left: 250px;
                padding: 20px;
            }
            
            .analytics-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-active {
            background: #28a745;
        }

        .status-error {
            background: #dc3545;
        }

        .usage-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .usage-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .template-editor {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            min-height: 200px;
            padding: 15px;
            font-family: monospace;
        }

        .color-picker {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .color-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .color-input input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 900px;
            max-height: calc(100vh - 40px);
            margin: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 1001;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(100vh - 140px);
        }

        /* Custom scrollbar for modal */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
        }

        /* Mobile responsive scrolling */
        @media (max-width: 768px) {
            .modal {
                padding: 10px 0;
                align-items: flex-start;
            }
            
            .modal-content {
                width: 95%;
                max-height: calc(100vh - 20px);
                margin-top: 10px;
            }
            
            .modal-body {
                max-height: calc(100vh - 120px);
                padding: 20px 15px;
            }
            
            .order-detail-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .order-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .order-detail-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .order-detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-detail-value {
            font-size: 16px;
            color: #212529;
            word-break: break-all;
        }

        .order-content-section {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .order-content-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .user-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .user-detail-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .user-detail-value {
            font-size: 16px;
            color: #333;
        }

        .actions-column {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-width: 80px;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-view {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-view:hover {
            background: linear-gradient(135deg, #5a6fd8, #6a4190);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-block {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-block:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .btn-unblock {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-unblock:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-complete {
            background: #28a745;
            color: white;
        }

        .btn-complete:hover {
            background: #1e7e34;
        }

        /* Dropdown menu styling */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-toggle {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .dropdown-toggle:hover {
            background: #545b62;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 4px;
            z-index: 1000;
            border: 1px solid #ddd;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item.view {
            color: #007bff;
        }

        .dropdown-item.complete {
            color: #28a745;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: #28a745; /* Green */
        }

        .stat-change.negative {
            color: #dc3545; /* Red */
        }
        .table-header-payment {
    height: 30px !important;
    padding: 8px 15px !important;
    vertical-align: middle;
}

.table-header-payment i {
    margin-right: 8px;
    font-size: 14px;
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="admin-container">
        <aside class="sidebar">
            <div class="logo">
                <h2>üåü Wispwish Admin</h2>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-chart-line"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="users">
                            <i class="fas fa-users"></i>
                            User Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="orders">
                            <i class="fas fa-gift"></i>
                            Orders Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="api-monitoring">
                            <i class="fas fa-server"></i>
                            AI API Monitoring
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="payments">
                            <i class="fas fa-credit-card"></i>
                            Payments & Invoices
                        </a>
                    </li>
                    <!-- <li class="nav-item">
                        <a href="#" class="nav-link" data-section="content">
                            <i class="fas fa-edit"></i>
                            Content Control
                        </a>
                    </li> -->
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="email">
                            <i class="fas fa-envelope"></i>
                            Email Integration
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="templates">
                            <i class="fas fa-file-alt"></i>
                            Gift Library
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="analytics">
                            <i class="fas fa-chart-bar"></i>
                            Reports & Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-section="system-health">
                            <i class="fas fa-heartbeat"></i>
                            System Health
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            
            <header class="header">
                <div class="welcome">
                    <h1>Welcome back, Admin! üëã</h1>
                    <p>Here's what's happening with Wispwish today</p>
                </div>
            </header>

            <div class="error-message" id="errorMessage"></div>

            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="stat-number" id="total-orders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-number" id="total-revenue">$0.00</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="pending-orders">0</div>
                        <div class="stat-label">Pending Orders</div>
                    </div>
                </div>

                <div class="content-section">
                    <h2 class="section-title">Recent Activity</h2>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Activity</th>
                                <th>User</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity"></tbody>
                    </table>
                </div>

            </section>

            <section id="users" class="content-section">
                <h2 class="section-title">User Management</h2>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" class="form-input" placeholder="Search users..." style="width: 300px; display: inline-block;" id="userSearch">
                    <button class="btn btn-primary" style="margin-left: 10px;" onclick="fetchUsers(1, document.getElementById('userSearch').value)">Search</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Orders</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table"></tbody>
                </table>
            </section>

            <!-- User Details Modal -->
            <div id="userModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>User Details</h3>
                        <span class="close" onclick="closeUserModal()">&times;</span>
                    </div>
                    <div class="modal-body" id="userModalBody">
                        <!-- User details will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Order Details Modal -->
            <div id="orderModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Order Details</h3>
                        <span class="close" onclick="closeOrderModal()">&times;</span>
                    </div>
                    <div class="modal-body" id="orderModalBody">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
            </div>

            <section id="orders" class="content-section">
                <h2 class="section-title">Orders Management</h2>
                
                <div style="margin-bottom: 20px; display: flex; gap: 15px;">
                    <select class="form-input" style="width: 200px;" id="orderStatusFilter" onchange="fetchOrders(1, this.value.toLowerCase(), document.getElementById('orderTypeFilter').value.toLowerCase())">
                        <option>All Orders</option>
                        <option>Pending</option>
                        <option>Processing</option>
                        <option>Completed</option>
                        <option>Failed</option>
                    </select>
                    <select class="form-input" style="width: 200px;" id="orderTypeFilter" onchange="fetchOrders(1, document.getElementById('orderStatusFilter').value.toLowerCase(), this.value.toLowerCase())">
                        <option>All Gift Types</option>
                        <option>Poems</option>
                        <option>Voice Messages</option>
                        <option>Illustrations</option>
                        <option>Videos</option>
                    </select>
                </div>

                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>User</th>
                                <th>Gift Type</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table"></tbody>
                    </table>
                </div>
            </section>

            <section id="api-monitoring" class="content-section">
                <h2 class="section-title">AI API Monitoring</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>OpenAI API</h3>
                            <div class="api-status">
                                <div class="status-indicator status-active"></div>
                                <span>Active</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Usage</span>
                                <span>75%</span>
                            </div>
                            <div class="usage-bar">
                                <div class="usage-fill" style="width: 75%;"></div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666;">7,500 / 10,000 requests used</p>
                    </div>

                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>ElevenLabs API</h3>
                            <div class="api-status">
                                <div class="status-indicator status-active"></div>
                                <span>Active</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Usage</span>
                                <span>45%</span>
                            </div>
                            <div class="usage-bar">
                                <div class="usage-fill" style="width: 45%;"></div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #666;">450 / 1,000 characters used</p>
                    </div>

                    <div class="stat-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>RunwayML API</h3>
                            <div class="api-status">
                                <div class="status-indicator status-error"></div>
                                <span>Error</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Usage</span>
                                <span>90%</span>
                            </div>
                            <div class="usage-bar">
                                <div class="usage-fill" style="width: 90%;"></div>
                            </div>
                        </div>
                        <p style="font-size: 12px; color: #dc3545;">Quota exceeded - upgrade needed</p>
                    </div>
                </div>

                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">Recent API Errors</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>API</th>
                                <th>Error</th>
                                <th>Order ID</th>
                            </tr>
                        </thead>
                        <tbody id="api-errors"></tbody>
                    </table>
                </div>
            </section>

            <section id="payments" class="content-section">
                <h2 class="section-title">üí≥ Payments & Invoices</h2>
                
                <!-- Enhanced Filter Section -->
                <div class="filter-section">
                    <div class="filter-group">
                        <select class="form-input modern-select" id="paymentStatusFilter" onchange="fetchPayments(1, this.value.toLowerCase())">
                            <option value="all">All Payments</option>
                            <option value="pending">‚è≥ Pending</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="failed">‚ùå Failed</option>
                            <option value="refunded">üîÑ Refunded</option>
                        </select>
                        <input type="text" class="form-input search-input" placeholder="üîç Search payments..." id="paymentSearch">
                        <button class="btn btn-primary search-btn" onclick="fetchPayments(1, document.getElementById('paymentStatusFilter').value.toLowerCase(), document.getElementById('paymentSearch').value)">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportPayments()">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-info" onclick="fetchPayments()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Enhanced Stats Cards -->
                <div class="stats-grid payment-stats">
                    <!-- Today's Revenue Card -->
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-value" id="today-revenue">$0.00</div>
                        <div class="stat-label">Today's Revenue</div>
                        <div class="stat-change" id="today-change">+0%</div>
                    </div>

                    <!-- This Week Card -->
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value" id="week-revenue">$0.00</div>
                        <div class="stat-label">This Week</div>
                        <div class="stat-change" id="week-change">+0%</div>
                    </div>

                    <!-- This Month Card -->
                    <div class="stat-card">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-value" id="month-revenue">$0.00</div>
                        <div class="stat-label">This Month</div>
                        <div class="stat-change" id="month-change">+0%</div>
                    </div>

                    <!-- Pending Orders Card ⁄©Ÿà Pending Payments ŸÖ€å⁄∫ ÿ™ÿ®ÿØ€åŸÑ ⁄©ÿ±€å⁄∫ -->
                    <div class="stat-card">
                        <div class="stat-icon">üí≥</div>
                        <div class="stat-value" id="pending-payments-count">0</div>
                        <div class="stat-label">Pending Payments</div>
                        <div class="stat-change" id="pending-payments-change">-</div>
                    </div>
                </div>

                <!-- Enhanced Table -->
                <div class="table-container">
                    <table class="data-table modern-table">
                        <thead class="table-header-payment">
                            <tr>
                                <th><i class="fas fa-hashtag"></i> Payment ID</th>
                                <th><i class="fas fa-shopping-cart"></i> Order ID</th>
                                <th><i class="fas fa-user"></i> Customer</th>
                                <th><i class="fas fa-dollar-sign"></i> Amount</th>
                                <th><i class="fas fa-credit-card"></i> Method</th>
                                <th><i class="fas fa-info-circle"></i> Status</th>
                                <th><i class="fas fa-calendar"></i> Date</th>
                                <th><i class="fas fa-cogs"></i> Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table"></tbody>
                    </table>
                </div>

                <!-- Enhanced Modal -->
                <div id="paymentDetailsModal" class="modal modern-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2><i class="fas fa-credit-card"></i> Payment Details</h2>
                            <span class="modal-close" onclick="closeModal('paymentDetailsModal')">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="paymentDetailsContent"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="generateInvoice()">
                                <i class="fas fa-file-pdf"></i> Generate Invoice
                            </button>
                            <button class="btn btn-warning" onclick="initiateRefund()">
                                <i class="fas fa-undo"></i> Initiate Refund
                            </button>
                            <button class="btn btn-secondary" onclick="closeModal('paymentDetailsModal')">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- <section id="content" class="content-section">
                <h2 class="section-title">Content Control</h2>
                
                <div style="display: grid; gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">Homepage Content</h3>
                        <div class="form-group">
                            <label class="form-label">Hero Headline</label>
                            <input type="text" class="form-input" value="Gifts born from the heart, delivered in seconds." />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sub-headline</label>
                            <input type="text" class="form-input" value="You bring the feeling. We turn it into a gift." />
                        </div>
                        <button class="btn btn-primary">Save Changes</button>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">Color Theme</h3>
                        <div class="color-picker">
                            <div class="color-input">
                                <label>Primary Color</label>
                                <input type="color" value="#667eea" />
                            </div>
                            <div class="color-input">
                                <label>Secondary Color</label>
                                <input type="color" value="#764ba2" />
                            </div>
                            <div class="color-input">
                                <label>Accent Color</label>
                                <input type="color" value="#f093fb" />
                            </div>
                        </div>
                        <button class="btn btn-primary" style="margin-top: 15px;">Update Theme</button>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">About Us Content</h3>
                        <textarea class="form-input" rows="6" placeholder="Enter about us content..."></textarea>
                        <button class="btn btn-primary" style="margin-top: 10px;">Save</button>
                    </div>
                </div>
            </section> -->


            

            <section id="email" class="content-section">
                <h2 class="section-title">Email Integration</h2>
                
                <!-- Mailgun Configuration -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Mailgun Configuration</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mailgun API Key</label>
                            <input type="password" id="mailgunApiKey" class="form-input" placeholder="Enter Mailgun API Key">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mailgun Domain</label>
                            <input type="text" id="mailgunDomain" class="form-input" placeholder="Enter Mailgun Domain">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">From Email</label>
                            <input type="email" id="fromEmail" class="form-input" placeholder="noreply@yourdomain.com">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">From Name</label>
                            <input type="text" id="fromName" class="form-input" placeholder="Wispwish">
                        </div>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 15px;" onclick="saveEmailSettings()">Save Configuration</button>
                    <button class="btn btn-success" style="margin-top: 15px; margin-left: 10px;" onclick="testEmailConnection()">Test Connection</button>
                </div>

                <!-- Email Templates Management -->
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Email Templates</h3>
                        <button class="btn btn-success" onclick="showCreateTemplateModal()">Create New Template</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                        <!-- Template List -->
                        <div>
                            <h4>Available Templates</h4>
                            <div id="templateList" style="max-height: 400px; overflow-y: auto;"></div>
                        </div>
                        
                        <!-- Template Editor -->
                        <div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Template</label>
                                <select id="templateSelect" class="form-input" onchange="loadTemplate()">
                                    <option value="">Select a template...</option>
                                </select>
                            </div>
                            
                            <div id="templateEditor" style="display: none;">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Template Name</label>
                                    <input type="text" id="templateName" class="form-input">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email Subject</label>
                                    <input type="text" id="templateSubject" class="form-input">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email Content (HTML)</label>
                                    <textarea id="templateContent" class="form-input" rows="10" style="font-family: monospace;"></textarea>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Available Variables</label>
                                    <div id="templateVariables" style="padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px;"></div>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
                                    <button class="btn btn-success" onclick="showTestEmailModal()">Send Test Email</button>
                                    <button class="btn btn-danger" id="deleteTemplateBtn" onclick="deleteTemplate()" style="display: none;">Delete Template</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="templates" class="content-section">
                <h2 class="section-title">Gift Library Management</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary">Add New Template</button>
                </div>

                <div style="display: grid; gap: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">Poem Templates</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Template Name</th>
                                    <th>Occasion</th>
                                    <th>Tone</th>
                                    <th>Usage Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Birthday Love Poem</td>
                                    <td>Birthday</td>
                                    <td>Romantic</td>
                                    <td>156</td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;">Edit</button>
                                        <button class="btn btn-danger" style="padding: 5px 10px;">Delete</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Grief Support Message</td>
                                    <td>Loss</td>
                                    <td>Comforting</td>
                                    <td>89</td>
                                    <td>
                                        <button class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;">Edit</button>
                                        <button class="btn btn-danger" style="padding: 5px 10px;">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="background: white; padding: 20px; border-radius: 10px;">
                        <h3 style="margin-bottom: 15px;">Voice Styles</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Voice Name</th>
                                    <th>Gender</th>
                                    <th>Accent</th>
                                    <th>Usage Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="voiceStylesTableBody">
                                <tr id="voiceStylesLoadingRow"><td colspan="5">Loading voice styles...</td></tr>
                            </tbody>
                        </table>
                        <div style="margin-top: 12px; display:flex; gap:10px; align-items:center;">
                            <input id="newVoiceName" class="form-input" placeholder="Voice Name" style="max-width: 180px;" />
                            <input id="newVoiceId" class="form-input" placeholder="ElevenLabs Voice ID" style="max-width: 220px;" />
                            <select id="newVoiceGender" class="form-input" style="max-width: 140px;">
                                <option value="unknown">Gender</option>
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                                <option value="other">Other</option>
                            </select>
                            <input id="newVoiceAccent" class="form-input" placeholder="Accent (optional)" style="max-width: 180px;" />
                            <button class="btn btn-primary" onclick="createVoiceStyle()">Add Voice</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="analytics" class="content-section">
                <h2 class="section-title">Reports & Analytics</h2>
                
                <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                    <select class="form-input" style="width: 200px;" id="analyticsPeriod">
                        <option value="7days">Last 7 days</option>
                        <option value="30days" selected>Last 30 days</option>
                        <option value="90days">Last 3 months</option>
                        <option value="1year">Last year</option>
                    </select>
                    <button class="btn btn-primary" onclick="fetchAnalytics(document.getElementById('analyticsPeriod').value)">
                        <i class="fas fa-chart-bar"></i> Generate Report
                    </button>
                </div>

                <!-- Loading Spinner -->
                <div id="analytics-loading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 15px; color: #666;">Loading analytics data...</p>
                </div>

                <!-- Stats Grid with Loading States -->
                <div class="stats-grid" id="analytics-stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-number" id="poems-count">
                            <div class="loading-placeholder">...</div>
                        </div>
                        <div class="stat-label">Poems Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <div class="stat-number" id="voice-count">
                            <div class="loading-placeholder">...</div>
                        </div>
                        <div class="stat-label">Voice Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-paint-brush"></i>
                        </div>
                        <div class="stat-number" id="illustration-count">
                            <div class="loading-placeholder">...</div>
                        </div>
                        <div class="stat-label">Illustrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <div class="stat-number" id="video-count">
                            <div class="loading-placeholder">...</div>
                        </div>
                        <div class="stat-label">Videos Created</div>
                    </div>
                </div>

                <!-- Charts Section with Better Layout -->
                <div class="analytics-charts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 30px;">
                    <!-- Popular Occasions -->
                    <div class="chart-card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #333; font-size: 18px;">
                            <i class="fas fa-calendar-alt" style="margin-right: 8px; color: #007bff;"></i>
                            Most Popular Occasions
                        </h3>
                        <div id="occasions-chart" style="min-height: 200px;">
                            <div class="loading-placeholder" style="text-align: center; padding: 60px 0; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>Loading occasions data...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Breakdown -->
                    <div class="chart-card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #333; font-size: 18px;">
                            <i class="fas fa-dollar-sign" style="margin-right: 8px; color: #28a745;"></i>
                            Revenue Breakdown
                        </h3>
                        <div id="revenue-chart" style="min-height: 200px;">
                            <div class="loading-placeholder" style="text-align: center; padding: 60px 0; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>Loading revenue data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Analytics Row -->
                <div class="analytics-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 25px;">
                    <!-- Total Orders -->
                    <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="total-orders">
                            <div class="loading-placeholder" style="color: rgba(255,255,255,0.8);">...</div>
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Orders</div>
                    </div>

                    <!-- Completion Rate -->
                    <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="completion-rate">
                            <div class="loading-placeholder" style="color: rgba(255,255,255,0.8);">...</div>
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">Completion Rate</div>
                    </div>

                    <!-- Total Revenue -->
                    <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; margin-bottom: 5px;" id="total-revenue">
                            <div class="loading-placeholder" style="color: rgba(255,255,255,0.8);">...</div>
                        </div>
                        <div style="font-size: 14px; opacity: 0.9;">Total Revenue</div>
                    </div>
                </div>
            </section>

            <section id="system-health" class="content-section">
                <h2 class="section-title">System Health</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Database Status</h3>
                        <div class="api-status">
                            <div class="status-indicator" id="db-status"></div>
                            <span id="db-status-text"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>OpenAI API</h3>
                        <div class="api-status">
                            <div class="status-indicator" id="openai-status"></div>
                            <span id="openai-status-text"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>ElevenLabs API</h3>
                        <div class="api-status">
                            <div class="status-indicator" id="elevenlabs-status"></div>
                            <span id="elevenlabs-status-text"></span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <h3>RunwayML API</h3>
                        <div class="api-status">
                            <div class="status-indicator" id="runwayml-status"></div>
                            <span id="runwayml-status-text"></span>
                        </div>
                    </div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>Server Metrics</h3>
                    <p>Uptime: <span id="server-uptime"></span></p>
                    <p>Memory Usage: <span id="server-memory"></span></p>
                    <p>CPU Usage: <span id="server-cpu"></span></p>
                </div>
            </section>
        </main>
    </div>

    <script>
        let currentPaymentId = null;
        let currentTemplate = null;
        let emailTemplates = [];
        let voiceStyles = [];

        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            if (!token) {
                window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/Frontend/admin-portal/';
                return;
            }
            fetch('http://localhost:5001/api/auth/me', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(data => {
                    if (!data.success || !data.user || data.user.role !== 'admin') {
                        window.location.href = 'http://127.0.0.1:5500/Frontend/';
                    } else {
                        fetchDashboardStats();
                        loadVoiceStyles();

                    }
                })
                .catch(() => {
                    window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/Frontend/admin-portal/';
                });

            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.content-section');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    contentSections.forEach(section => section.classList.remove('active'));
                    const targetSection = this.getAttribute('data-section');
                    const targetElement = document.getElementById(targetSection);
                    
                    if (targetElement) {
                        targetElement.classList.add('active');

                        if (targetSection === 'dashboard') {
                            fetchDashboardStats();
                        } else if (targetSection === 'users') {
                            fetchUsers();
                        } else if (targetSection === 'orders') {
                            const statusSelect = document.querySelector('#orders select:nth-child(1)');
                            const typeSelect = document.querySelector('#orders select:nth-child(2)');
                            const status = statusSelect ? statusSelect.value.toLowerCase() : 'all';
                            const type = typeSelect ? typeSelect.value.toLowerCase() : 'all';
                            fetchOrders(1, status === 'all orders' ? 'all' : status, type === 'all gift types' ? 'all' : type);
                        } else if (targetSection === 'api-monitoring') {
                            fetchAPIMonitoring();
                        } else if (targetSection === 'payments') {
                            fetchPayments(1, 'all');
                            // Also update dashboard stats for payment cards
                            setTimeout(() => fetchDashboardStats(), 500);
                        } else if (targetSection === 'email') {
                            fetchEmailSettings();
                            fetchEmailTemplates();
                        } else if (targetSection === 'templates') {
                            loadVoiceStyles();
                        } else if (targetSection === 'analytics') {
                            const periodSelect = document.querySelector('#analytics select');
                            const period = periodSelect ? periodSelect.value.toLowerCase() : 'monthly';
                            fetchAnalytics(period);
                        } else if (targetSection === 'system-health') {
                            fetchSystemHealth();
                        }
                    }
                });
            });

            const periodFilter = document.querySelector('#analytics select');
            if (periodFilter) {
                periodFilter.addEventListener('change', () => {
                    const period = periodFilter.value.toLowerCase();
                    const analyticsSection = document.getElementById('analytics');
                    if (analyticsSection && analyticsSection.classList.contains('active')) {
                        fetchAnalytics(period);
                    }
                });
            }
        });

    //  const API_BASE_URL = 'http://localhost:5001/api';

async function loadVoiceStyles() {
    const loadingRow = document.getElementById('voiceStylesLoadingRow');
    const tbody = document.getElementById('voiceStylesTableBody');
    const errorMessage = document.getElementById('errorMessage');

    loadingRow.style.display = 'block';
    tbody.innerHTML = '';

    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/voice-styles`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || 'Failed to load voice styles');
        }
        voiceStyles = await res.json();
        renderVoiceStyles();
    } catch (e) {
        console.error('Error:', e.message);
        errorMessage.textContent = e.message || 'Failed to load voice styles';
        errorMessage.style.display = 'block';
        tbody.innerHTML = `<tr><td colspan="5">${e.message}</td></tr>`;
    } finally {
        loadingRow.style.display = 'none';
    }
}

async function toggleVoiceStatus(id, currentStatus) {
    const button = document.querySelector(`button[onclick="toggleVoiceStatus('${id}', ${currentStatus})"]`);
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'Updating...';

    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        console.log(`Sending PATCH request to toggle isActive to ${!currentStatus} for voice style ID: ${id}`);
        const res = await fetch(`${API_BASE_URL}/voice-styles/${id}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ isActive: !currentStatus })
        });
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(errorData.error || 'Failed to update voice style status');
        }
        const updatedVoiceStyle = await res.json();
        console.log('Updated voice style:', updatedVoiceStyle);

        // Update local voiceStyles array with the response from the server
        voiceStyles = voiceStyles.map(v => v._id === id ? { ...v, isActive: updatedVoiceStyle.isActive } : v);
        renderVoiceStyles();
    } catch (e) {
        console.error('Error:', e.message);
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.textContent = e.message || 'Failed to update voice style status';
        errorMessage.style.display = 'block';
        button.textContent = originalText;
        button.disabled = false;
    } finally {
        if (button.textContent === 'Updating...') {
            button.textContent = originalText;
            button.disabled = false;
        }
    }
}

function renderVoiceStyles() {
    const tbody = document.getElementById('voiceStylesTableBody');
    tbody.innerHTML = '';
    if (!voiceStyles.length) {
        tbody.innerHTML = '<tr><td colspan="5">No voice styles found</td></tr>';
        return;
    }
    voiceStyles.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${v.name}${v.isDefault ? ' <span style="color:#28a745; font-size:12px;">(default)</span>' : ''}</td>
            <td>${v.gender || ''}</td>
            <td>${v.accent || ''}</td>
            <td>
                <button class="btn ${v.isActive ? 'btn-success' : 'btn-warning'}" 
                        onclick="toggleVoiceStatus('${v._id}', ${v.isActive})">
                    ${v.isActive ? 'Active' : 'Inactive'}
                </button>
            </td>
            <td>
                <button class="btn btn-primary" onclick="previewVoice('${v._id}', '')">Preview</button>
                <button class="btn btn-success" onclick="setDefaultVoice('${v._id}')">Set Default</button>
                <button class="btn ${v.isActive ? 'btn-warning' : 'btn-info'}" 
                        onclick="setActiveVoice('${v._id}')" ${v.isActive ? 'disabled' : ''}>
                    ${v.isActive ? 'Already Active' : 'Select & Activate'}
                </button>
                <button class="btn btn-danger" onclick="deleteVoice('${v._id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function createVoiceStyle() {
    const name = document.getElementById('newVoiceName').value.trim();
    const voiceId = document.getElementById('newVoiceId').value.trim();
    const gender = document.getElementById('newVoiceGender').value;
    const accent = document.getElementById('newVoiceAccent').value.trim();
    const previewUrl = document.getElementById('newVoicePreviewUrl').value.trim();
    const errorDiv = document.getElementById('formError');
    const addBtn = document.getElementById('addVoiceBtn');

    if (!name || !voiceId) {
        errorDiv.innerHTML = 'Enter name and ElevenLabs voice ID';
        return;
    }

    errorDiv.innerHTML = '';
    addBtn.disabled = true;
    addBtn.textContent = 'Adding...';

    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/voice-styles`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ name, voiceId, gender, accent, previewUrl })
        });
        if (!res.ok) throw new Error('Failed to create voice style');
        const created = await res.json();
        voiceStyles.unshift(created);
        renderVoiceStyles();
        document.getElementById('newVoiceName').value = '';
        document.getElementById('newVoiceId').value = '';
        document.getElementById('newVoiceGender').value = 'unknown';
        document.getElementById('newVoiceAccent').value = '';
        document.getElementById('newVoicePreviewUrl').value = '';
    } catch (e) {
        errorDiv.innerHTML = e.message;
    } finally {
        addBtn.disabled = false;
        addBtn.textContent = 'Add Voice';
    }
}

async function setDefaultVoice(id) {
    const errorDiv = document.getElementById('tableError');
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/voice-styles/${id}/set-default`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to set default voice');
        const updated = await res.json();
        voiceStyles = voiceStyles.map(v => ({ ...v, isDefault: v._id === updated._id }));
        renderVoiceStyles();
    } catch (e) {
        errorDiv.innerHTML = e.message;
    }
}

async function setActiveVoice(id) {
    if (!confirm('Set this as the active voice? This will deactivate all other voices.')) return;
    const errorDiv = document.getElementById('tableError');
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/voice-styles/${id}/set-active`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to set active voice');
        const updated = await res.json();
        voiceStyles = voiceStyles.map(v => ({ ...v, isActive: v._id === updated._id }));
        renderVoiceStyles();
    } catch (e) {
        errorDiv.innerHTML = e.message;
    }
}

async function deleteVoice(id) {
    if (!confirm('Delete this voice style?')) return;
    const errorDiv = document.getElementById('tableError');
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/voice-styles/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to delete voice style');
        voiceStyles = voiceStyles.filter(v => v._id !== id);
        renderVoiceStyles();
    } catch (e) {
        errorDiv.innerHTML = e.message;
    }
}

function previewVoice(id, url) {
    if (!url) {
        alert('No preview available for this voice');
        return;
    }
    const audio = new Audio(url);
    audio.play();
}

// Load voices on page load
document.addEventListener('DOMContentLoaded', loadVoiceStyles);
        async function fetchDashboardStats() {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) {
                    console.error('No token found, redirecting to login');
                    window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                    return;
                }

                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
                
                const totalUsersEl = document.getElementById('total-users');
                const totalOrdersEl = document.getElementById('total-orders');
                const pendingOrdersEl = document.getElementById('pending-orders');
                const totalRevenueEl = document.getElementById('total-revenue');
                
                if (totalUsersEl) totalUsersEl.textContent = 'Loading...';
                if (totalOrdersEl) totalOrdersEl.textContent = 'Loading...';
                if (pendingOrdersEl) pendingOrdersEl.textContent = 'Loading...';
                if (totalRevenueEl) totalRevenueEl.textContent = 'Loading...';

                const response = await fetch(`${API_BASE_URL}/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error, redirecting to login');
                        window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                if (totalUsersEl) totalUsersEl.textContent = data.totalUsers ? data.totalUsers.toLocaleString() : '0';
                if (totalOrdersEl) totalOrdersEl.textContent = data.totalOrders ? data.totalOrders.toLocaleString() : '0';
                if (pendingOrdersEl) pendingOrdersEl.textContent = data.pendingOrders ? data.pendingOrders.toLocaleString() : '0';
                if (totalRevenueEl) totalRevenueEl.textContent = data.totalRevenue ? `$${data.totalRevenue.toFixed(2)}` : '$0.00';

                // Update revenue breakdown with dynamic percentages
                if (data.revenueBreakdown) {
                    // Today's revenue
                    document.getElementById('today-revenue').textContent = `$${data.revenueBreakdown.today.amount.toFixed(2)}`;
                    const todayChangeEl = document.getElementById('today-change');
                    todayChangeEl.textContent = `${data.revenueBreakdown.today.isPositive ? '+' : ''}${data.revenueBreakdown.today.change}%`;
                    todayChangeEl.className = `stat-change ${data.revenueBreakdown.today.isPositive ? 'positive' : 'negative'}`;
                    
                    // This week's revenue
                    document.getElementById('week-revenue').textContent = `$${data.revenueBreakdown.thisWeek.amount.toFixed(2)}`;
                    const weekChangeEl = document.getElementById('week-change');
                    weekChangeEl.textContent = `${data.revenueBreakdown.thisWeek.isPositive ? '+' : ''}${data.revenueBreakdown.thisWeek.change}%`;
                    weekChangeEl.className = `stat-change ${data.revenueBreakdown.thisWeek.isPositive ? 'positive' : 'negative'}`;
                    
                    // This month's revenue
                    document.getElementById('month-revenue').textContent = `$${data.revenueBreakdown.thisMonth.amount.toFixed(2)}`;
                    const monthChangeEl = document.getElementById('month-change');
                    monthChangeEl.textContent = `${data.revenueBreakdown.thisMonth.isPositive ? '+' : ''}${data.revenueBreakdown.thisMonth.change}%`;
                    monthChangeEl.className = `stat-change ${data.revenueBreakdown.thisMonth.isPositive ? 'positive' : 'negative'}`;
                }
                
                // Update pending payments count instead of pending orders
                if (data.pendingPayments !== undefined) {
                    const pendingPaymentsEl = document.getElementById('pending-payments-count');
                    if (pendingPaymentsEl) {
                        pendingPaymentsEl.textContent = data.pendingPayments;
                    }
                }

                const activityTable = document.getElementById('recent-activity');
                if (activityTable) {
                    activityTable.innerHTML = '';
                    if (!data.recentActivity || data.recentActivity.length === 0) {
                        activityTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No recent activity</td></tr>';
                    } else {
                        data.recentActivity.forEach(activity => {
                            const tr = document.createElement('tr');
                            const status = activity.status || 'unknown';
                            const userEmail = activity.userId && activity.userId.email ? activity.userId.email : 'Unknown User';
                            tr.innerHTML = `
                                <td>${new Date(activity.createdAt).toLocaleString()}</td>
                                <td>${activity.type || 'Unknown'}</td>
                                <td>${userEmail}</td>
                                <td><span class="status-badge status-${status.toLowerCase()}">${status}</span></td>
                            `;
                            activityTable.appendChild(tr);
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching dashboard stats:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load dashboard data';
                    errorMessage.style.display = 'block';
                }
            }
        }

        

        async function fetchUsers(page = 1, search = '') {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) {
                    console.error('No token found, redirecting to login');
                    window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                    return;
                }

                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'none';
                const usersTable = document.getElementById('users-table');
                usersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';

                const response = await fetch(`${API_BASE_URL}/users?page=${page}&search=${encodeURIComponent(search)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error, redirecting to login');
                        window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                usersTable.innerHTML = '';
                if (!data.users || data.users.length === 0) {
                    usersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
                } else {
                    data.users.forEach(user => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user._id}</td>
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.email}</td>
                            <td>${user.orderCount || 0}</td>
                            <td><span class="status-badge status-${user.isEmailVerified ? 'completed' : 'pending'}">${user.isEmailVerified ? 'Verified' : 'Unverified'}</span></td>
                            <td>
                                <div class="actions-column">
                                    <button class="action-btn btn-view" onclick="viewUser('${user._id}')" title="View User Details">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="action-btn ${user.isBlocked ? 'btn-unblock' : 'btn-block'}" onclick="blockUser('${user._id}', '${user.isBlocked ? 'unblock' : 'block'}')" title="${user.isBlocked ? 'Unblock User' : 'Block User'}">
                                        <i class="fas fa-${user.isBlocked ? 'unlock' : 'lock'}"></i> ${user.isBlocked ? 'Unblock' : 'Block'}
                                    </button>
                                </div>
                            </td>
                        `;
                        usersTable.appendChild(tr);
                    });
                }

const paginationDiv = document.createElement('div');
paginationDiv.className = 'pagination';
paginationDiv.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    width: 100%;
    padding: 0 20px;
    box-sizing: border-box;
`;

paginationDiv.innerHTML = `
    <div style=" text-align: left;">
        <button class="btn btn-primary" ${data.currentPage <= 1 ? 'disabled' : ''} onclick="fetchOrders(${data.currentPage - 1}, '${status}', '${type}')" style="min-width: 80px;">Previous</button>
    </div>
    <div style=" text-align: center;">
        <span style="font-weight: bold;">Page ${data.currentPage} of ${data.totalPages}</span>
    </div>
    <div style=" text-align: right;">
        <button class="btn btn-primary" ${data.currentPage >= data.totalPages ? 'disabled' : ''} onclick="fetchOrders(${data.currentPage + 1}, '${status}', '${type}')" style="min-width: 80px;">Next</button>
    </div>
`;

const existingPagination = document.querySelector('.pagination');
if (existingPagination) existingPagination.remove();
ordersTable.parentElement.appendChild(paginationDiv);
            } catch (error) {
                console.error('Error fetching users:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load users data';
                    errorMessage.style.display = 'block';
                }
            }
        }

async function viewUser(userId) {
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        if (!token) throw new Error('No token found');

        console.log('Fetching user details for:', userId); // Debug log

        // Show loading
        document.getElementById('userModalBody').innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
        document.getElementById('userModal').style.display = 'flex';

        const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        console.log('Response status:', response.status); // Debug log

        if (!response.ok) {
            const errorData = await response.json();
            console.error('API Error:', errorData); // Debug log
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        console.log('User data received:', data); // Debug log
        
        const user = data.user;

        // Format the user details
        const modalBody = document.getElementById('userModalBody');
        modalBody.innerHTML = `
            <div class="user-detail-grid">
                <div class="user-detail-item">
                    <div class="user-detail-label">User ID</div>
                    <div class="user-detail-value">${user._id}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Name</div>
                    <div class="user-detail-value">${user.name || 'N/A'}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Email</div>
                    <div class="user-detail-value">${user.email}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Role</div>
                    <div class="user-detail-value">${user.role}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Email Verified</div>
                    <div class="user-detail-value">
                        <span class="status-badge status-${user.isEmailVerified ? 'completed' : 'pending'}">
                            ${user.isEmailVerified ? 'Verified' : 'Unverified'}
                        </span>
                    </div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Account Status</div>
                    <div class="user-detail-value">
                        <span class="status-badge status-${user.isBlocked ? 'failed' : 'completed'}">
                            ${user.isBlocked ? 'Blocked' : 'Active'}
                        </span>
                    </div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Total Orders</div>
                    <div class="user-detail-value">${user.totalOrders}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Total Spent</div>
                    <div class="user-detail-value">$${user.totalSpent.toFixed(2)}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Joined Date</div>
                    <div class="user-detail-value">${new Date(user.joinedDate).toLocaleDateString()}</div>
                </div>
                <div class="user-detail-item">
                    <div class="user-detail-label">Last Login</div>
                    <div class="user-detail-value">${user.lastLogin !== 'Never' ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</div>
                </div>
            </div>
            
            ${user.recentOrders && user.recentOrders.length > 0 ? `
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Recent Orders</h4>
                <table class="data-table" style="font-size: 14px;">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${user.recentOrders.map(order => `
                            <tr>
                                <td>${order.type}</td>
                                <td>$${order.payment?.amount || 0}</td>
                                <td><span class="status-badge status-${order.paymentStatus}">${order.paymentStatus}</span></td>
                                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="margin-top: 20px; text-align: center; color: #666;">No recent orders</p>'}
        `;

    } catch (error) {
        console.error('Error fetching user details:', error);
        document.getElementById('userModalBody').innerHTML = `
            <div style="text-align: center; padding: 20px; color: #e74c3c;">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                <p>Failed to load user details</p>
                <p style="font-size: 14px; opacity: 0.7;">${error.message}</p>
                <button class="btn btn-primary" onclick="viewUser('${userId}')" style="margin-top: 10px;">Retry</button>
            </div>
        `;
    }
}


function closeUserModal() {
    document.getElementById('userModal').style.display = 'none';
}

function closeOrderModal() {
    document.getElementById('orderModal').style.display = 'none';
}

// Close modal when clicking outside (existing user modal code ⁄©€í ÿ≥ÿßÿ™⁄æ update ⁄©ÿ±€å⁄∫)
window.onclick = function(event) {
    const userModal = document.getElementById('userModal');
    const orderModal = document.getElementById('orderModal');
    if (event.target === userModal) {
        closeUserModal();
    }
    if (event.target === orderModal) {
        closeOrderModal();
    }
}

        async function blockUser(userId, action) {
            try {
                if (!confirm(`Are you sure you want to ${action} this user?`)) return;
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                const endpoint = action === 'block' ? `${API_BASE_URL}/users/${userId}/block` : `${API_BASE_URL}/users/${userId}/unblock`;
                const response = await fetch(endpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                alert(`User ${action}ed successfully`);
                fetchUsers();
            } catch (error) {
                console.error(`Error ${action}ing user:`, error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || `Failed to ${action} user`;
                    errorMessage.style.display = 'block';
                }
            }
        }

        async function fetchOrders(page = 1, status = 'all', type = 'all') {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) {
                    console.error('No token found, redirecting to login');
                    window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                    return;
                }

                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'none';
                const ordersTable = document.getElementById('orders-table');
                ordersTable.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

                const response = await fetch(`${API_BASE_URL}/orders?page=${page}&status=${status}&type=${type}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error, redirecting to login');
                        window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                ordersTable.innerHTML = '';
                if (!data.orders || data.orders.length === 0) {
                    ordersTable.innerHTML = '<tr><td colspan="7" style="text-align: center;">No orders found</td></tr>';
                } else {
                    data.orders.forEach(order => {
    const tr = document.createElement('tr');
    const userDisplay = order.userId ? order.userId.email || 'N/A' : 'Guest';
    const statusDisplay = order.paymentStatus || 'Unknown';
    const statusClass = statusDisplay.toLowerCase();
    tr.innerHTML = `
        <td><span class="order-id" title="${order._id}">${order._id.substring(0, 8)}...</span></td>
        <td title="${userDisplay}">${userDisplay}</td>
        <td>${order.type}</td>
        <td>$${order.payment?.amount?.toFixed(2) || '0.00'}</td>
        <td><span class="status-badge status-${statusClass}">${statusDisplay}</span></td>
        <td>${new Date(order.createdAt).toLocaleDateString()}</td>
        <td>
            <div class="actions-column">
                <button class="action-btn btn-view" onclick="viewOrder('${order._id}')" title="View Order Details">View</button>
                ${statusDisplay.toLowerCase() === 'pending' ? `<button class="action-btn btn-complete" onclick="updateOrderStatus('${order._id}', 'completed')" title="Mark as Complete">Complete</button>` : ''}
            </div>
        </td>
    `;
    ordersTable.appendChild(tr);
});
                }

                const paginationDiv = document.createElement('div');
paginationDiv.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 30px;
    width: 100%;
    padding: 0 20px;
    box-sizing: border-box;
`;

paginationDiv.innerHTML = `
    <div style="flex: 1; text-align: left;">
        <button class="btn btn-primary" ${data.currentPage <= 1 ? 'disabled' : ''} onclick="fetchOrders(${data.currentPage - 1}, '${status}', '${type}')" style="min-width: 80px;">Previous</button>
    </div>
    <div style="flex: 1; text-align: center; font-weight: bold;">
        Page ${data.currentPage} of ${data.totalPages}
    </div>
    <div style="flex: 1; text-align: right;">
        <button class="btn btn-primary" ${data.currentPage >= data.totalPages ? 'disabled' : ''} onclick="fetchOrders(${data.currentPage + 1}, '${status}', '${type}')" style="min-width: 80px;">Next</button>
    </div>
`;

const existingPagination = document.querySelector('.pagination');
if (existingPagination) existingPagination.remove();

// Append to the orders section, not the table wrapper
const ordersSection = document.getElementById('orders');
ordersSection.appendChild(paginationDiv);
            } catch (error) {
                console.error('Error fetching orders:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load orders data';
                    errorMessage.style.display = 'block';
                }
            }
        }

        async function viewOrder(orderId) {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                console.log('Fetching order details for:', orderId);

                // Show loading
                document.getElementById('orderModalBody').innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
                document.getElementById('orderModal').style.display = 'flex';

                const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const order = await response.json();
                console.log('Order data received:', order);
                
                // Format the order details
                const modalBody = document.getElementById('orderModalBody');
                modalBody.innerHTML = `
                    <div class="order-detail-grid">
                        <div class="order-detail-item">
                            <div class="order-detail-label">Order ID</div>
                            <div class="order-detail-value">${order._id}</div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Customer</div>
                            <div class="order-detail-value">
                                <strong>${order.userId?.name || 'N/A'}</strong><br>
                                <small>${order.userId?.email || 'N/A'}</small>
                            </div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Gift Type</div>
                            <div class="order-detail-value">${order.type || 'N/A'}</div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Price</div>
                            <div class="order-detail-value">$${order.price?.toFixed(2) || order.payment?.amount?.toFixed(2) || '0.00'}</div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Payment Status</div>
                            <div class="order-detail-value">
                                <span class="status-badge status-${order.paymentStatus?.toLowerCase() || 'pending'}">
                                    ${order.paymentStatus || 'Pending'}
                                </span>
                            </div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Order Status</div>
                            <div class="order-detail-value">
                                <span class="status-badge status-${order.status?.toLowerCase() || 'pending'}">
                                    ${order.status || 'Pending'}
                                </span>
                            </div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Created Date</div>
                            <div class="order-detail-value">${new Date(order.createdAt).toLocaleDateString()} ${new Date(order.createdAt).toLocaleTimeString()}</div>
                        </div>
                        <div class="order-detail-item">
                            <div class="order-detail-label">Updated Date</div>
                            <div class="order-detail-value">${order.updatedAt ? new Date(order.updatedAt).toLocaleDateString() + ' ' + new Date(order.updatedAt).toLocaleTimeString() : 'N/A'}</div>
                        </div>
                        ${order.completedAt ? `
                        <div class="order-detail-item">
                            <div class="order-detail-label">Completed Date</div>
                            <div class="order-detail-value">${new Date(order.completedAt).toLocaleDateString()} ${new Date(order.completedAt).toLocaleTimeString()}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${order.payment ? `
                        <div class="order-content-section">
                            <h4><i class="fas fa-credit-card"></i> Payment Details</h4>
                            <div class="order-detail-grid">
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Payment ID</div>
                                    <div class="order-detail-value">${order.payment._id || 'N/A'}</div>
                                </div>
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Amount</div>
                                    <div class="order-detail-value">$${order.payment.amount?.toFixed(2) || '0.00'}</div>
                                </div>
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Payment Method</div>
                                    <div class="order-detail-value">${order.payment.method || 'N/A'}</div>
                                </div>
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Transaction ID</div>
                                    <div class="order-detail-value">${order.payment.transactionId || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${order.giftId ? `
                        <div class="order-content-section">
                            <h4><i class="fas fa-gift"></i> Gift Details</h4>
                            <div class="order-detail-grid">
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Gift ID</div>
                                    <div class="order-detail-value">${order.giftId._id || order.giftId}</div>
                                </div>
                                <div class="order-detail-item">
                                    <div class="order-detail-label">Gift Type</div>
                                    <div class="order-detail-value">${order.giftId.type || order.type}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e9ecef;">
                        ${order.paymentStatus === 'pending' ? `
                            <button class="btn btn-success" onclick="updateOrderStatus('${order._id}', 'completed')" style="margin-right: 10px;">
                                <i class="fas fa-check"></i> Mark as Complete
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="closeOrderModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('Error fetching order details:', error);
                document.getElementById('orderModalBody').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Failed to load order details</p>
                        <p style="font-size: 14px; opacity: 0.7;">${error.message}</p>
                        <button class="btn btn-primary" onclick="viewOrder('${orderId}')" style="margin-top: 10px;">Retry</button>
                    </div>
                `;
            }
        }

        async function updateOrderStatus(orderId, status) {
            try {
                if (!confirm(`Are you sure you want to mark this order as ${status}?`)) return;
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                const response = await fetch(`${API_BASE_URL}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                alert(`Order status updated to ${status}`);
                fetchOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to update order status';
                    errorMessage.style.display = 'block';
                }
            }
        }

//         async function fetchPayments(page = 1, status = 'all', search = '') {
//             try {
//                 const token = sessionStorage.getItem('token') || localStorage.getItem('token');
//                 if (!token) {
//                     console.error('No token found, redirecting to login');
//                     window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
//                     return;
//                 }

//                 const errorMessage = document.getElementById('errorMessage');
//                 errorMessage.style.display = 'none';
//                 const paymentsTable = document.getElementById('payments-table');
//                 paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

//                 const response = await fetch(`${API_BASE_URL}/payments?page=${page}&status=${status}&search=${encodeURIComponent(search)}`, {
//                     headers: {
//                         'Authorization': `Bearer ${token}`,
//                         'Content-Type': 'application/json'
//                     }
//                 });

//                 if (!response.ok) {
//                     const errorData = await response.json();
//                     if (response.status === 401 || response.status === 403) {
//                         console.error('Authentication error, redirecting to login');
//                         window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
//                         throw new Error('Authentication failed. Please log in again.');
//                     }
//                     throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
//                 }

//                 const data = await response.json();
                
//                 // Update revenue stats with correct IDs
//                 const todayStats = data.revenueStats.find(s => s._id.day === new Date().getDate());
//                 const weeklyRevenue = data.revenueStats.slice(0, 7).reduce((sum, s) => sum + s.dailyRevenue, 0);
//                 const monthlyRevenue = data.revenueStats.reduce((sum, s) => sum + s.dailyRevenue, 0);
                
//                 // Update the correct elements
//                 const todayRevenueEl = document.getElementById('today-revenue');
//                 const weekRevenueEl = document.getElementById('week-revenue');
//                 const monthRevenueEl = document.getElementById('month-revenue');
//                 const pendingPaymentsEl = document.getElementById('pending-payments-count');
                
//                 if (todayRevenueEl) todayRevenueEl.textContent = `$${todayStats?.dailyRevenue.toFixed(2) || '0.00'}`;
//                 if (weekRevenueEl) weekRevenueEl.textContent = `$${weeklyRevenue.toFixed(2)}`;
//                 if (monthRevenueEl) monthRevenueEl.textContent = `$${monthlyRevenue.toFixed(2)}`;
//                 if (pendingPaymentsEl) pendingPaymentsEl.textContent = data.totalPayments.toLocaleString();

//                 paymentsTable.innerHTML = '';
//                 if (!data.payments || data.payments.length === 0) {
//                     paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">No payments found</td></tr>';
//                 } else {
//                     data.payments.forEach(payment => {
//                         const tr = document.createElement('tr');
//                         tr.innerHTML = `
//                             <td>${payment._id}</td>
//                             <td>${payment.order?._id || 'N/A'}</td>
//                             <td>${payment.userId?.email || 'N/A'}</td>
//                             <td>$${payment.amount.toFixed(2)}</td>
//                             <td>${payment.method}</td>
//                             <td><span class="status-badge status-${payment.status.toLowerCase()}">${payment.status}</span></td>
//                             <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
//                             <td>
//                                 <button class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;" onclick="viewPayment('${payment._id}')">View</button>
//                                 ${payment.status === 'completed' ? `<button class="btn btn-warning" style="padding: 5px 10px;" onclick="initiateRefund('${payment._id}')">Refund</button>` : ''}
//                             </td>
//                         `;
//                         paymentsTable.appendChild(tr);
//                     });
//                 }

//                const paginationDiv = document.createElement('div');
// paginationDiv.className = 'pagination';
// paginationDiv.style.cssText = `
//     display: flex;
//     justify-content: space-between;
//     align-items: center;
//     margin-top: 20px;
//     width: 100%;
//     padding: 0 20px;
//     box-sizing: border-box;
// `;

// paginationDiv.innerHTML = `
//     <div style="flex: 1; text-align: left;">
//         <button class="btn btn-primary" ${data.currentPage <= 1 ? 'disabled' : ''} onclick="fetchPayments(${data.currentPage - 1}, '${status}', '${search}')" style="min-width: 80px;">Previous</button>
//     </div>
//     <div style="flex: 1; text-align: center; font-weight: bold;">
//         Page ${data.currentPage} of ${data.totalPages}
//     </div>
//     <div style="flex: 1; text-align: right;">
//         <button class="btn btn-primary" ${data.currentPage >= data.totalPages ? 'disabled' : ''} onclick="fetchPayments(${data.currentPage + 1}, '${status}', '${search}')" style="min-width: 80px;">Next</button>
//     </div>
// `;

// const existingPagination = document.querySelector('.pagination');
// if (existingPagination) existingPagination.remove();
// paymentsTable.parentElement.appendChild(paginationDiv);

//             } catch (error) {
//                 console.error('Error fetching payments:', error);
//                 const paymentsTable = document.getElementById('payments-table');
//                 if (paymentsTable) {
//                     paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error loading payments data</td></tr>';
//                 }
//                 const errorMessage = document.getElementById('errorMessage');
//                 if (errorMessage) {
//                     errorMessage.textContent = error.message || 'Failed to load payments data';
//                     errorMessage.style.display = 'block';
//                 }
//             }
//         }


        async function fetchPayments(page = 1, status = 'all', search = '') {
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        if (!token) {
            console.error('No token found, redirecting to login');
            window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
            return;
        }

        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';
        const paymentsTable = document.getElementById('payments-table');
        paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

        const response = await fetch(`${API_BASE_URL}/payments?page=${page}&status=${status}&search=${encodeURIComponent(search)}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                console.error('Authentication error, redirecting to login');
                window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                throw new Error('Authentication failed. Please log in again.');
            }
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        
        // Update revenue stats with correct IDs
        const todayStats = data.revenueStats.find(s => s._id.day === new Date().getDate());
        const weeklyRevenue = data.revenueStats.slice(0, 7).reduce((sum, s) => sum + s.dailyRevenue, 0);
        const monthlyRevenue = data.revenueStats.reduce((sum, s) => sum + s.dailyRevenue, 0);
        
        // Update the correct elements
        const todayRevenueEl = document.getElementById('today-revenue');
        const weekRevenueEl = document.getElementById('week-revenue');
        const monthRevenueEl = document.getElementById('month-revenue');
        const pendingPaymentsEl = document.getElementById('pending-payments-count');
        
        if (todayRevenueEl) todayRevenueEl.textContent = `$${todayStats?.dailyRevenue.toFixed(2) || '0.00'}`;
        if (weekRevenueEl) weekRevenueEl.textContent = `$${weeklyRevenue.toFixed(2)}`;
        if (monthRevenueEl) monthRevenueEl.textContent = `$${monthlyRevenue.toFixed(2)}`;
        if (pendingPaymentsEl) pendingPaymentsEl.textContent = data.totalPayments.toLocaleString();

        paymentsTable.innerHTML = '';
        if (!data.payments || data.payments.length === 0) {
            paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center;">No payments found</td></tr>';
        } else {
            data.payments.forEach(payment => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${payment._id}</td>
                    <td>${payment.order?._id || 'N/A'}</td>
                    <td>${payment.userId?.email || 'N/A'}</td>
                    <td>$${payment.amount.toFixed(2)}</td>
                    <td>${payment.method}</td>
                    <td><span class="status-badge status-${payment.status.toLowerCase()}">${payment.status}</span></td>
                    <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 5px 10px; margin-right: 5px;" onclick="viewPayment('${payment._id}')">View</button>
                        ${payment.status === 'completed' ? `<button class="btn btn-warning" style="padding: 5px 10px;" onclick="initiateRefund('${payment._id}')">Refund</button>` : ''}
                    </td>
                `;
                paymentsTable.appendChild(tr);
            });
        }

        // FIXED PAGINATION CODE
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination';
        paginationDiv.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        `;

        paginationDiv.innerHTML = `
            <div style="flex: 1; text-align: left;">
                <button class="btn btn-primary" ${data.currentPage <= 1 ? 'disabled' : ''} onclick="fetchPayments(${data.currentPage - 1}, '${status}', '${search}')" style="min-width: 80px;">Previous</button>
            </div>
            <div style="flex: 1; text-align: center; font-weight: bold;">
                Page ${data.currentPage} of ${data.totalPages}
            </div>
            <div style="flex: 1; text-align: right;">
                <button class="btn btn-primary" ${data.currentPage >= data.totalPages ? 'disabled' : ''} onclick="fetchPayments(${data.currentPage + 1}, '${status}', '${search}')" style="min-width: 80px;">Next</button>
            </div>
        `;

        const existingPagination = document.querySelector('.pagination');
        if (existingPagination) existingPagination.remove();
        
        // Append to the table container instead of table parent
        const tableContainer = document.querySelector('.table-container');
        tableContainer.appendChild(paginationDiv);

    } catch (error) {
        console.error('Error fetching payments:', error);
        const paymentsTable = document.getElementById('payments-table');
        if (paymentsTable) {
            paymentsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error loading payments data</td></tr>';
        }
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = error.message || 'Failed to load payments data';
            errorMessage.style.display = 'block';
        }
    }
}

// CSS fix for table head height - Add this to your CSS file
const fixTableHeadStyle = `
    .modern-table thead th {
        height: 20px !important;
        padding: 12px 15px !important;
        vertical-align: middle;
    }
    
    .modern-table thead th i {
        margin-right: 8px;
        font-size: 14px;
    }
    
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        width: 100%;
        padding: 0 20px;
        box-sizing: border-box;
    }
`;

// Add the CSS fix
const styleElement = document.createElement('style');
styleElement.textContent = fixTableHeadStyle;
document.head.appendChild(styleElement);


        async function viewPayment(paymentId) {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                const response = await fetch(`${API_BASE_URL}/payments/${paymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const payment = await response.json();
                currentPaymentId = paymentId;
                const modalContent = document.getElementById('paymentDetailsContent');
                modalContent.innerHTML = `
                    <p><strong>Payment ID:</strong> ${payment._id}</p>
                    <p><strong>Order ID:</strong> ${payment.order?._id || 'N/A'}</p>
                    <p><strong>User:</strong> ${payment.userId?.email || 'N/A'}</p>
                    <p><strong>Amount:</strong> $${payment.amount.toFixed(2)}</p>
                    <p><strong>Method:</strong> ${payment.method}</p>
                    <p><strong>Status:</strong> ${payment.status}</p>
                    <p><strong>Date:</strong> ${new Date(payment.createdAt).toLocaleString()}</p>
                    ${payment.transactionId ? `<p><strong>Transaction ID:</strong> ${payment.transactionId}</p>` : ''}
                `;
                document.getElementById('paymentDetailsModal').style.display = 'flex';
            } catch (error) {
                console.error('Error fetching payment details:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load payment details';
                    errorMessage.style.display = 'block';
                }
            }
        }

        async function initiateRefund(paymentId = currentPaymentId) {
            try {
                if (!confirm('Are you sure you want to initiate a refund for this payment?')) return;
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                const response = await fetch(`${API_BASE_URL}/payments/${paymentId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                alert('Refund initiated successfully');
                closeModal('paymentDetailsModal');
                fetchPayments();
            } catch (error) {
                console.error('Error initiating refund:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to initiate refund';
                    errorMessage.style.display = 'block';
                }
            }
        }

        // Email Settings Functions
async function fetchEmailSettings() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/email/settings`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch email settings');
        }

        const settings = await response.json();
        
        // Populate form fields
        document.getElementById('mailgunApiKey').value = settings.mailgunApiKey || '';
        document.getElementById('mailgunDomain').value = settings.mailgunDomain || '';
        document.getElementById('fromEmail').value = settings.fromEmail || '';
        document.getElementById('fromName').value = settings.fromName || 'Wispwish';
        
    } catch (error) {
        console.error('Error fetching email settings:', error);
        alert('Failed to load email settings');
    }
}

async function saveEmailSettings() {
    try {
        const token = localStorage.getItem('token');
        const settings = {
            mailgunApiKey: document.getElementById('mailgunApiKey').value,
            mailgunDomain: document.getElementById('mailgunDomain').value,
            fromEmail: document.getElementById('fromEmail').value,
            fromName: document.getElementById('fromName').value
        };

        const response = await fetch(`${API_BASE_URL}/email/settings`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });

        if (!response.ok) {
            throw new Error('Failed to save email settings');
        }

        alert('Email settings saved successfully!');
    } catch (error) {
        console.error('Error saving email settings:', error);
        alert('Failed to save email settings');
    }
}

async function testEmailConnection() {
    try {
        const token = localStorage.getItem('token');
        const testEmail = prompt('Enter email address to send test email:');
        
        if (!testEmail) return;

        const response = await fetch(`${API_BASE_URL}/email/test`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                templateId: emailTemplates.find(t => t.slug === 'welcome_email')?._id,
                toEmail: testEmail,
                testData: {
                    customer_name: 'Test User',
                    website_url: window.location.origin
                }
            })
        });

        if (!response.ok) {
            throw new Error('Failed to send test email');
        }

        alert('Test email sent successfully!');
    } catch (error) {
        console.error('Error sending test email:', error);
        alert('Failed to send test email');
    }
}

// Email Template Functions
async function fetchEmailTemplates() {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/email-templates`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch email templates');
        }

        emailTemplates = await response.json();
        populateTemplateSelect();
        populateTemplateList();
        
    } catch (error) {
        console.error('Error fetching email templates:', error);
        alert('Failed to load email templates');
    }
}

function populateTemplateSelect() {
    const select = document.getElementById('templateSelect');
    select.innerHTML = '<option value="">Select a template...</option>';
    
    // Define the preferred order for templates
    const preferredOrder = [
        'Order Confirmation',
        'Gift Delivery', 
        'Payment Receipt',
        'Welcome Email'
    ];
    
    // Sort templates according to preferred order
    const sortedTemplates = [...emailTemplates].sort((a, b) => {
        const aIndex = preferredOrder.indexOf(a.name);
        const bIndex = preferredOrder.indexOf(b.name);
        
        // If both are in preferred order, sort by their position
        if (aIndex !== -1 && bIndex !== -1) {
            return aIndex - bIndex;
        }
        // If only one is in preferred order, it comes first
        if (aIndex !== -1) return -1;
        if (bIndex !== -1) return 1;
        // If neither is in preferred order, sort alphabetically
        return a.name.localeCompare(b.name);
    });
    
    // Add templates to dropdown
    sortedTemplates.forEach(template => {
        const option = document.createElement('option');
        option.value = template._id;
        option.textContent = template.name;
        select.appendChild(option);
    });
}

function populateTemplateList() {
    const list = document.getElementById('templateList');
    list.innerHTML = '';
    
    emailTemplates.forEach(template => {
        const item = document.createElement('div');
        item.style.cssText = 'padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; cursor: pointer; background: #f8f9fa;';
        item.innerHTML = `
            <div style="font-weight: bold;">${template.name}</div>
            <div style="font-size: 12px; color: #666;">${template.slug}</div>
        `;
        item.onclick = () => {
            document.getElementById('templateSelect').value = template._id;
            loadTemplate();
        };
        list.appendChild(item);
    });
}

async function loadTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        document.getElementById('templateEditor').style.display = 'none';
        return;
    }

    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/email-templates/${templateId}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to fetch template');
        }

        currentTemplate = await response.json();
        
        // Populate editor
        document.getElementById('templateName').value = currentTemplate.name;
        document.getElementById('templateSubject').value = currentTemplate.subject;
        document.getElementById('templateContent').value = currentTemplate.content;
        
        // Show variables
        const variablesDiv = document.getElementById('templateVariables');
        if (currentTemplate.variables && currentTemplate.variables.length > 0) {
            variablesDiv.innerHTML = currentTemplate.variables.map(v => `{{${v}}}`).join(', ');
        } else {
            variablesDiv.innerHTML = 'No variables defined';
        }
        
        document.getElementById('templateEditor').style.display = 'block';
        document.getElementById('deleteTemplateBtn').style.display = 'inline-block';
        
    } catch (error) {
        console.error('Error loading template:', error);
        alert('Failed to load template');
    }
}

async function saveTemplate() {
    if (!currentTemplate) return;

    try {
        const token = localStorage.getItem('token');
        const templateData = {
            name: document.getElementById('templateName').value,
            subject: document.getElementById('templateSubject').value,
            content: document.getElementById('templateContent').value
        };

        const response = await fetch(`${API_BASE_URL}/email-templates/${currentTemplate._id}`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(templateData)
        });

        if (!response.ok) {
            throw new Error('Failed to save template');
        }

        alert('Template saved successfully!');
        fetchEmailTemplates(); // Refresh the list
        
    } catch (error) {
        console.error('Error saving template:', error);
        alert('Failed to save template');
    }
}

async function deleteTemplate() {
    if (!currentTemplate) return;

    if (!confirm(`Are you sure you want to delete the template "${currentTemplate.name}"?`)) {
        return;
    }

    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/email-templates/${currentTemplate._id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to delete template');
        }

        alert('Template deleted successfully!');
        document.getElementById('templateEditor').style.display = 'none';
        document.getElementById('templateSelect').value = '';
        currentTemplate = null;
        fetchEmailTemplates(); // Refresh the list
        
    } catch (error) {
        console.error('Error deleting template:', error);
        alert('Failed to delete template');
    }
}

function showTestEmailModal() {
    if (!currentTemplate) return;

    const email = prompt('Enter email address to send test email:');
    if (!email) return;

    sendTestEmail(email);
}

async function sendTestEmail(email) {
    try {
        const token = localStorage.getItem('token');
        const testData = {
            customer_name: 'Test User',
            order_id: 'TEST-12345',
            gift_type: 'Test Gift',
            amount: '25.00',
            status: 'Test',
            website_url: window.location.origin,
            gift_link: window.location.origin + '/gift/test',
            payment_method: 'Test Card',
            transaction_id: 'TEST-TXN-12345',
            payment_date: new Date().toISOString()
        };

        const response = await fetch(`${API_BASE_URL}/email/test`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                templateId: currentTemplate._id,
                toEmail: email,
                testData: testData
            })
        });

        if (!response.ok) {
            throw new Error('Failed to send test email');
        }

        alert('Test email sent successfully!');
    } catch (error) {
        console.error('Error sending test email:', error);
        alert('Failed to send test email');
    }
}

function showCreateTemplateModal() {
    const name = prompt('Enter template name:');
    if (!name) return;

    const subject = prompt('Enter email subject:');
    if (!subject) return;

    createNewTemplate(name, subject);
}

async function createNewTemplate(name, subject) {
    try {
        const token = localStorage.getItem('token');
        const templateData = {
            name: name,
            subject: subject,
            content: `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                <h2 style="color: #4a90e2;">${name}</h2>
                <p>Hi {{customer_name}},</p>
                <p>Your content goes here...</p>
                <p>Best regards,<br>The Wispwish Team</p>
            </div>`,
            variables: ['customer_name']
        };

        const response = await fetch(`${API_BASE_URL}/email-templates`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(templateData)
        });

        if (!response.ok) {
            throw new Error('Failed to create template');
        }

        alert('Template created successfully!');
        fetchEmailTemplates(); // Refresh the list
        
    } catch (error) {
        console.error('Error creating template:', error);
        alert('Failed to create template');
    }
}

async function generateInvoice(paymentId = currentPaymentId) {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) throw new Error('No token found');

                const response = await fetch(`${API_BASE_URL}/payments/${paymentId}/invoice`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url.toString();
                a.download = `invoice_${paymentId}.pdf`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error generating invoice:', error);
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to generate invoice';
                    errorMessage.style.display = 'block';
                }
            }
        }

        // async function fetchAPIMonitoring() {
        //     try {
        //         const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        //         if (!token.toString()) {
        //             throw new Error('No token found');
        //         }
        //         const errorMessage = document.getElementById('errorMessage');
        //         errorMessage.style.display = 'none';

        //         const response = await fetch(`${API_BASE_URL}/api-monitoring`, {
        //             headers: {
        //                 'Authorization': `Bearer ${token}`,
        //                 'Content-Type': 'application/json'
        //             }
        //         });

        //         if (!response.ok) {
        //             const errorData = await response.json();
        //             if (response.status === 401 || response.status === 403) {
        //                 throw new Error('Authentication failed. Please log in again.');
        //             }
        //             throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        //         }

        //         const data = await response.json();
        //         const apiMonitoringSection = document.getElementById('api-monitoring');
        //         const statCards = apiMonitoringSection.querySelectorAll('.stat-card');

        //         statCards.forEach(stat => {
        //             const card = stat.querySelector('h3');
        //             let title = card.textContent.toLowerCase();
        //             let provider;
        //             if (title.includes('openai')) provider = 'openai';
        //             else if (title.includes('elevenlabs')) provider = 'elevenlabs';
        //             else if (title.includes('runwayml')) provider = 'runwayml';

        //             const usageData = data.apiUsage.find((api => api.provider === provider));
        //             if (usageData) {
        //                 const statusIndicator = stat.querySelector('.status-indicator');
        //                 const statusText = stat.querySelector('.api-status span');
        //                 const usagePercentage = stat.querySelector('.usage-fill');
        //                 const usageText = card.querySelector('p');

        //                 statusIndicator.className = `status-indicator status-${usageData.status.toLowerCase() === 'active' ? 'active' : 'error'}`;
        //                 statusText.textContent = usageData.status;

        //                 const usagePercentageSpan = stat.querySelector('div:nth-child(2) div span:last-child');
        //                 if (usagePercentageSpan) {
        //                     usagePercentageSpan.textContent = `${usageData.usagePercentage}%`;
        //                 }
        //                 usagePercentage.style.width = `${usageData.usagePercentage}%`;

        //                 if (usageData.unit === 'requests') {
        //                     usageText.textContent = `${usageData.totalRequests.toLocaleString()} / ${usageData.quotaLimit.toLocaleString()} requests used`;
        //                 } else {
        //                     usageText.textContent = `${usageData.totalCharacters.toLocaleString()} / ${usageData.quotaLimit.toLocaleString()} characters used`;
        //                 }

        //                 if (usageData.status === 'Error') {
        //                     usageText.style.color = '#dc3545';
        //                 } else {
        //                     usageText.style.color = '#666';
        //                 }
        //             }
        //         });

        //         const errorsTable = apiMonitoringSection.querySelector('tbody');
        //         errorsTable.innerHTML = '';
        //         if (!data.recentErrors || data.recentErrors.length === 0) {
        //             errorsTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No recent errors</td></tr>';
        //         } else {
        //             data.recentErrors.forEach(error => {
        //                 const tr = document.createElement('tr');
        //                 tr.innerHTML = `
        //                     <td>${new Date(error.time).toLocaleString()}</td>
        //                     <td>${error.provider.charAt(0).toUpperCase() + error.provider.slice(1)}</td>
        //                     <td>${error.errorMessage}</td>
        //                     <td>${error.orderId}</td>
        //                 `;
        //                 errorsTable.appendChild(tr);
        //             });
        //         }
        //     } catch (error) {
        //         console.error('Error fetching API monitoring data:', error);
        //         const errorMessage = document.getElementById('errorMessage');
        //         if (errorMessage) {
        //             errorMessage.textContent = error.message || 'Failed to load API monitoring data';
        //             errorMessage.style.display = 'block';
        //         }
        //     }
        // }



        const API_BASE_URL = 'http://localhost:5001/api';

function showSection(sectionId) {
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
    });
    document.getElementById(sectionId).classList.remove('hidden');
    if (sectionId === 'api-monitoring') {
        fetchAPIMonitoring();
    }
}

async function fetchAPIMonitoring() {
    try {
        const token = sessionStorage.getItem('token') || localStorage.getItem('token');
        if (!token) {
            throw new Error('No token found');
        }
        const errorMessage = document.getElementById('errorMessage');
        errorMessage.style.display = 'none';

        const response = await fetch(`${API_BASE_URL}/api-monitoring`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 401 || response.status === 403) {
                throw new Error('Authentication failed. Please log in again.');
            }
            throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        const apiMonitoringSection = document.getElementById('api-monitoring');
        const statCards = apiMonitoringSection.querySelectorAll('.stat-card');

        statCards.forEach(stat => {
            const provider = stat.getAttribute('data-provider');
            const usageData = data.apiUsage.find(api => api.provider === provider);
            if (usageData) {
                const statusIndicator = stat.querySelector('.status-indicator');
                const statusText = stat.querySelector('.api-status span');
                const usagePercentage = stat.querySelector(`#${provider}-usage-percentage`);
                const usageFill = stat.querySelector(`#${provider}-usage-fill`);
                const usageText = stat.querySelector(`#${provider}-usage-text`);

                statusIndicator.className = `status-indicator status-${usageData.status.toLowerCase() === 'active' ? 'active' : 'error'}`;
                statusText.textContent = usageData.status;
                usagePercentage.textContent = `${usageData.usagePercentage}%`;
                usageFill.style.width = `${usageData.usagePercentage}%`;

                usageText.textContent = usageData.unit === 'requests'
                    ? `${usageData.totalRequests.toLocaleString()} / ${usageData.quotaLimit.toLocaleString()} requests used`
                    : `${usageData.totalCharacters.toLocaleString()} / ${usageData.quotaLimit.toLocaleString()} characters used`;
                usageText.style.color = usageData.status === 'Error' ? '#dc3545' : '#666';
            }
        });

        const errorsTable = apiMonitoringSection.querySelector('#api-errors');
        errorsTable.innerHTML = '';
        if (!data.recentErrors || data.recentErrors.length === 0) {
            errorsTable.innerHTML = '<tr><td colspan="4" style="text-align: center;">No recent errors</td></tr>';
        } else {
            data.recentErrors.forEach(error => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(error.time).toLocaleString()}</td>
                    <td>${error.provider.charAt(0).toUpperCase() + error.provider.slice(1)}</td>
                    <td>${error.errorMessage}</td>
                    <td>${error.orderId}</td>
                `;
                errorsTable.appendChild(tr);
            });
        }
    } catch (error) {
        console.error('Error fetching API monitoring data:', error);
        const errorMessage = document.getElementById('errorMessage');
        if (errorMessage) {
            errorMessage.textContent = error.message || 'Failed to load API monitoring data';
            errorMessage.style.display = 'block';
        }
    }
}


        async function fetchAnalytics(period = '30days') {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) {
                    console.error('No token found, redirecting to login');
                    window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                    return;
                }

                const errorMessage = document.getElementById('errorMessage');
                errorMessage.style.display = 'none';

                // Show loading states
                const loadingSpinner = document.querySelector('.analytics-loading');
                const statsGrid = document.querySelector('#analytics .stats-grid');
                const analyticsCharts = document.querySelector('.analytics-charts');
                const analyticsRow = document.querySelector('.analytics-row');

                if (loadingSpinner) loadingSpinner.style.display = 'block';

                // Show loading placeholders for stats
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-heart"></i></div>
                        <div class="stat-number"><div class="loading-placeholder"></div></div>
                        <div class="stat-label">Poems Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-microphone"></i></div>
                        <div class="stat-number"><div class="loading-placeholder"></div></div>
                        <div class="stat-label">Voice Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-paint-brush"></i></div>
                        <div class="stat-number"><div class="loading-placeholder"></div></div>
                        <div class="stat-label">Illustrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-video"></i></div>
                        <div class="stat-number"><div class="loading-placeholder"></div></div>
                        <div class="stat-label">Videos Created</div>
                    </div>
                `;

                // Show loading for charts
                const occasionsChart = analyticsCharts.querySelector('.chart-card:first-child');
                const revenueChart = analyticsCharts.querySelector('.chart-card:last-child');
                
                if (occasionsChart) {
                    occasionsChart.innerHTML = `
                        <h3>Most Popular Occasions</h3>
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px; color: #666;">Loading occasions data...</p>
                        </div>
                    `;
                }

                if (revenueChart) {
                    revenueChart.innerHTML = `
                        <h3>Revenue Breakdown</h3>
                        <div style="text-align: center; padding: 40px;">
                            <div class="spinner"></div>
                            <p style="margin-top: 15px; color: #666;">Loading revenue data...</p>
                        </div>
                    `;
                }

                // Show loading for additional metrics
                if (analyticsRow) {
                    analyticsRow.innerHTML = `
                        <div class="metric-card" style="background: linear-gradient(135deg, #28a745, #20c997);">
                            <h3 style="color: white; margin-bottom: 10px;">Total Orders</h3>
                            <div style="font-size: 32px; font-weight: bold; color: white;">
                                <div class="loading-placeholder" style="background: rgba(255,255,255,0.3);"></div>
                            </div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                            <h3 style="color: white; margin-bottom: 10px;">Completion Rate</h3>
                            <div style="font-size: 32px; font-weight: bold; color: white;">
                                <div class="loading-placeholder" style="background: rgba(255,255,255,0.3);"></div>
                            </div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                            <h3 style="color: white; margin-bottom: 10px;">Total Revenue</h3>
                            <div style="font-size: 32px; font-weight: bold; color: white;">
                                <div class="loading-placeholder" style="background: rgba(255,255,255,0.3);"></div>
                            </div>
                        </div>
                    `;
                }

                const response = await fetch(`${API_BASE_URL}/analytics?period=${period}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error, redirecting to login');
                        window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Hide loading spinner
                if (loadingSpinner) loadingSpinner.style.display = 'none';

                // Update stats grid with actual data
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-heart"></i></div>
                        <div class="stat-number">${data.giftTypeStats.find(s => s._id === 'poem')?.count || 0}</div>
                        <div class="stat-label">Poems Created</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-microphone"></i></div>
                        <div class="stat-number">${data.giftTypeStats.find(s => s._id === 'voice')?.count || 0}</div>
                        <div class="stat-label">Voice Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-paint-brush"></i></div>
                        <div class="stat-number">${data.giftTypeStats.find(s => s._id === 'illustration')?.count || 0}</div>
                        <div class="stat-label">Illustrations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-video"></i></div>
                        <div class="stat-number">${data.giftTypeStats.find(s => s._id === 'video')?.count || 0}</div>
                        <div class="stat-label">Videos Created</div>
                    </div>
                `;

                // Update occasions chart
                if (occasionsChart) {
                    occasionsChart.innerHTML = `
                        <h3 style="margin-bottom: 20px;">Most Popular Occasions</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${data.occasionStats.map(occasion => {
                                const percentage = ((occasion.count / data.occasionStats.reduce((sum, o) => sum + o.count, 0)) * 100).toFixed(0);
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span style="font-weight: 500;">${occasion._id || 'Other'}</span>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div class="usage-bar" style="width: 120px; height: 8px; background: #f0f0f0; border-radius: 4px;">
                                                <div class="usage-fill" style="width: ${percentage}%; height: 100%; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 4px; transition: width 0.5s ease;"></div>
                                            </div>
                                            <span style="font-weight: bold; min-width: 35px;">${percentage}%</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                // Update revenue chart
                if (revenueChart) {
                    const totalRevenue = data.revenueByType.reduce((sum, type) => sum + type.revenue, 0);
                    revenueChart.innerHTML = `
                        <h3 style="margin-bottom: 20px;">Revenue Breakdown</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${data.revenueByType.map(type => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-weight: 500;">${type._id.charAt(0).toUpperCase() + type._id.slice(1)}</span>
                                    <span style="font-weight: bold; color: #28a745;">$${type.revenue.toFixed(2)}</span>
                                </div>
                            `).join('')}
                            <hr style="margin: 10px 0; border: none; border-top: 2px solid #f0f0f0;">
                            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; color: #333;">
                                <span>Total Revenue</span>
                                <span style="color: #28a745;">$${totalRevenue.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }

                // Update additional metrics
                if (analyticsRow) {
                    analyticsRow.innerHTML = `
                        <div class="metric-card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                            <h3 style="margin-bottom: 10px;">Total Orders</h3>
                            <div style="font-size: 32px; font-weight: bold;">${data.totalOrders || 0}</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                            <h3 style="margin-bottom: 10px;">Completion Rate</h3>
                            <div style="font-size: 32px; font-weight: bold;">${data.completionRate || 0}%</div>
                        </div>
                        <div class="metric-card" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: white;">
                            <h3 style="margin-bottom: 10px;">Total Revenue</h3>
                            <div style="font-size: 32px; font-weight: bold;">$${data.totalRevenue || 0}</div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error fetching analytics:', error);
                
                // Hide loading spinner
                const loadingSpinner = document.querySelector('.analytics-loading');
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                
                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load analytics data';
                    errorMessage.style.display = 'block';
                }
            }
        }

        async function fetchSystemHealth() {
            try {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                if (!token) {
                    throw new Error('No token found');
                }

                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }

                // Show loading states
                const systemHealthSection = document.getElementById('system-health');
                if (systemHealthSection) {
                    // Add loading indicators
                    document.getElementById('db-status').className = 'status-indicator status-loading';
                    document.getElementById('db-status-text').textContent = 'Checking...';
                    document.getElementById('openai-status').className = 'status-indicator status-loading';
                    document.getElementById('openai-status-text').textContent = 'Checking...';
                    document.getElementById('elevenlabs-status').className = 'status-indicator status-loading';
                    document.getElementById('elevenlabs-status-text').textContent = 'Checking...';
                    document.getElementById('runwayml-status').className = 'status-indicator status-loading';
                    document.getElementById('runwayml-status-text').textContent = 'Checking...';
                    document.getElementById('server-uptime').textContent = 'Loading...';
                    document.getElementById('server-memory').textContent = 'Loading...';
                    document.getElementById('server-cpu').textContent = 'Loading...';
                }

                const response = await fetch(`${API_BASE_URL}/system/health`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (response.status === 401 || response.status === 403) {
                        console.error('Authentication error, redirecting to login');
                        window.location.href = 'http://127.0.0.1:5500/Frontend/login.html?redirect=/dashboard.html';
                        throw new Error('Authentication failed. Please log in again.');
                    }
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log('System health data received:', data);

                // Update Database Status
                const dbStatusEl = document.getElementById('db-status');
                const dbStatusTextEl = document.getElementById('db-status-text');
                if (dbStatusEl && dbStatusTextEl) {
                    dbStatusEl.className = `status-indicator status-${data.database === 'healthy' ? 'active' : 'error'}`;
                    dbStatusTextEl.textContent = data.database.charAt(0).toUpperCase() + data.database.slice(1);
                }

                // Update OpenAI Status
                const openaiStatusEl = document.getElementById('openai-status');
                const openaiStatusTextEl = document.getElementById('openai-status-text');
                if (openaiStatusEl && openaiStatusTextEl) {
                    const openaiStatus = data.apis?.openai?.status || 'error';
                    openaiStatusEl.className = `status-indicator status-${openaiStatus === 'healthy' ? 'active' : 'error'}`;
                    openaiStatusTextEl.textContent = openaiStatus === 'healthy' ? 'Active' : 'Error';
                }

                // Update ElevenLabs Status
                const elevenlabsStatusEl = document.getElementById('elevenlabs-status');
                const elevenlabsStatusTextEl = document.getElementById('elevenlabs-status-text');
                if (elevenlabsStatusEl && elevenlabsStatusTextEl) {
                    const elevenlabsStatus = data.apis?.elevenlabs?.status || 'error';
                    elevenlabsStatusEl.className = `status-indicator status-${elevenlabsStatus === 'healthy' ? 'active' : 'error'}`;
                    elevenlabsStatusTextEl.textContent = elevenlabsStatus === 'healthy' ? 'Active' : 'Error';
                }

                // Update RunwayML Status
                const runwaymlStatusEl = document.getElementById('runwayml-status');
                const runwaymlStatusTextEl = document.getElementById('runwayml-status-text');
                if (runwaymlStatusEl && runwaymlStatusTextEl) {
                    const runwaymlStatus = data.apis?.runwayml?.status || 'error';
                    runwaymlStatusEl.className = `status-indicator status-${runwaymlStatus === 'healthy' ? 'active' : 'error'}`;
                    runwaymlStatusTextEl.textContent = runwaymlStatus === 'healthy' ? 'Active' : 'Error';
                }

                // Update Server Metrics
                const serverUptimeEl = document.getElementById('server-uptime');
                const serverMemoryEl = document.getElementById('server-memory');
                const serverCpuEl = document.getElementById('server-cpu');

                if (serverUptimeEl && data.server?.uptime) {
                    const hours = Math.floor(data.server.uptime / 3600);
                    const minutes = Math.floor((data.server.uptime % 3600) / 60);
                    serverUptimeEl.textContent = `${hours}h ${minutes}m`;
                }

                if (serverMemoryEl && data.server?.memory) {
                    const heapUsed = (data.server.memory.heapUsed / 1024 / 1024).toFixed(2);
                    const heapTotal = (data.server.memory.heapTotal / 1024 / 1024).toFixed(2);
                    serverMemoryEl.textContent = `${heapUsed} MB / ${heapTotal} MB`;
                }

                if (serverCpuEl && data.server?.cpu) {
                    const cpuUsage = (data.server.cpu.user / 1000).toFixed(2);
                    serverCpuEl.textContent = `${cpuUsage} ms`;
                }

            } catch (error) {
                console.error('Error fetching system health:', error);
                
                // Show error states
                const statusElements = ['db-status', 'openai-status', 'elevenlabs-status', 'runwayml-status'];
                const textElements = ['db-status-text', 'openai-status-text', 'elevenlabs-status-text', 'runwayml-status-text'];
                
                statusElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.className = 'status-indicator status-error';
                });
                
                textElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'Error';
                });

                const errorMessage = document.getElementById('errorMessage');
                if (errorMessage) {
                    errorMessage.textContent = error.message || 'Failed to load system health data';
                    errorMessage.style.display = 'block';
                }
            }
        }
    </script>
</body>
</html>